<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Page Monitor Options</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <link rel="shortcut icon" type="image/png" href="image/browser_icon.png" />
  <link rel="stylesheet" type="text/css" href="lib/colorPicker.css" />
  <link rel="stylesheet" type="text/css" href="styles.css" />
  <script type="text/javascript" src="lib/jquery-1.4.1.js"></script>
  <script type="text/javascript" src="lib/jquery.colorPicker.js"></script>
  <script type="text/javascript" src="monitor.js"></script>
  <script type="text/javascript">
    function initializeColorPicker() {
      var toHex = function(d) {
        return d >= 16 ? d.toString(16) : '0' + d.toString(16);
      }
      
      var badge_color = getSetting(SETTINGS.badge_color);
      var badge_color = '#' + toHex(badge_color[0]) + 
                              toHex(badge_color[1]) +
                              toHex(badge_color[2]);
      
      $('#badge_color_picker').val(badge_color).change(function() {
        var color = $(this).val();
      
        setSetting(SETTINGS.badge_color, [parseInt(color.slice(1,3), 16),
                                          parseInt(color.slice(3,5), 16),
                                          parseInt(color.slice(5,7), 16),
                                          255]);
        updateBadge();
      }).colorPicker();
    }
    
    function initializeTimeoutTextbox() {
      var timeout = Math.round(getSetting(SETTINGS.timeout) / (60 * 1000));
      
      $('#global_timeout').val(timeout).keyup(function() {
        setSetting(SETTINGS.timeout, cleanTimeoutTextbox(this) * 60 * 1000);
      }).blur(function() { $(this).keyup(); });
    }
    
    function cleanTimeoutTextbox(textbox) {
      var caret_pos = textbox.selectionStart;
      var caret_end = textbox.selectionEnd;
      
      var str_timeout = $(textbox).val().replace(/[^.0-9]/g, '');
      var new_timeout = parseFloat(str_timeout) || 1;
      
      if (new_timeout <= 5 / 60) {
        new_timeout = 5 / 60;
      }
      
      if (str_timeout.match(/^0*\.|\.0*$/)) {
        $(textbox).val(str_timeout);
      } else {
        $(textbox).val(new_timeout);
      }
      
      textbox.selectionStart = caret_pos;
      textbox.selectionEnd = caret_end;
      
      return new_timeout;
    }
    
    // Returns the URL of the page record given any element in it.
    function findUrl(context) {
      return $(context).closest('.page_record').find('.page_link').get()[0].href;
    }
    
    // Returns the page record given its URL.
    function findPageRecord(url) {
      return $('.page_record').filter(function() {
        return $(this).has('a[href=' + url + ']');
      });
    }
    
    function fillPagesList() {
      var pages = getSetting(SETTINGS.pages_list);
      
      $('#pages').html('');
      
      if (pages.length > 0) {
        $.each(pages, function(i, url) {
          var page_record = $('#templates .page_record').clone();
          var advanced_set = false;
      
          var name = getPageSetting(url, SETTINGS.page.name) || 'Untitled (' + url + ')';
          if (name.length > 60) {
            name = name.replace(/([^]{20,60})(\w)\b.*$/, '$1$2...');
          }
          
          page_record.find('.page_link').attr({
            href: url
          }).text(name);
          
          page_record.find('.favicon').attr({
            src: getPageSetting(url, SETTINGS.page.icon) || 'img/page.png'
          });
          
          var last_check_updater = function() {
            var last_check = getPageSetting(url, SETTINGS.page.last_check);
            var last_check_span = page_record.find('.last_check_time');
            var last_check_message = last_check ? describeTimeSince(last_check) : 'never';
            
            if (last_check_message != last_check_span.text()) {
              last_check_span.fadeOut('slow', function() {
                $(this).text(last_check_message).fadeIn('slow');
              });
            }
          }
          last_check_updater();
          setInterval(last_check_updater, 15000);
          
          var timeout = getPageTimeout(url) / (60 * 1000);
          page_record.find('.timeout input[type=text]').val(timeout);
          if (getPageSetting(url, SETTINGS.page.timeout)) {
            page_record.find('.timeout span').addClass('enabled').removeClass('disabled');
            page_record.find('.timeout input').attr({ disabled: false });
            page_record.find('.timeout input[type=checkbox]').attr({ checked: true });
            advanced_set = true;
          }
          
          page_record.find('.mode input[type=radio]').attr({name: 'name' + crc(url) });
          
          var mode = getPageSetting(url, SETTINGS.page.mode);
          var regex = getPageSetting(url, SETTINGS.page.regex);
          var selector = getPageSetting(url, SETTINGS.page.selector);
          if (mode == null) {
            if (regex) {
              mode = 'regex';
            } else {
              mode = 'text';
            }
          }
          if (mode != 'text') {
            page_record.find('.mode span').first().addClass('enabled').removeClass('disabled');
            page_record.find('.mode input').attr({ disabled: false });
            page_record.find('.mode input[type=checkbox]').attr({ checked: true });
            page_record.find('.mode input[type=radio][value=' + mode + ']')
                       .click();
            if (mode == 'regex') {
              page_record.find('.mode input[type=text]').val(regex);
            } else if (mode == 'selector') {
              page_record.find('.mode input[type=text]').val(selector);
            }
            advanced_set = true;
          } else {
            page_record.find('.mode input[type=radio]').first().attr({ checked: true });
          }
          
          if (advanced_set) {
            page_record.find('.advanced_toggle input[type=checkbox]').attr({ checked: true });
            page_record.find('.advanced_toggle').addClass('toggled');
            page_record.find('.advanced_controls').css({ display: 'block' });
          }
          
          page_record.appendTo('#pages');
        });
      } else {
        $('#templates .empty').clone().appendTo('#pages');
      }
    }
    
    function setPageTimeout(context, timeout) {
      var url = findUrl(context);
      
      if (timeout === null)  {
        deletePageSetting(url, SETTINGS.page.timeout);
      } else {
        timeout = parseFloat(timeout) * 60 * 1000;
        if (timeout) {
          setPageSetting(url, SETTINGS.page.timeout, timeout);
          schedulePageCheck(url);
        }
      }
    }
    
    function setPageRegex(context, regex) {
      if (regex === null)  {
        deletePageSetting(findUrl(context), SETTINGS.page.regex);
        setPageSetting(findUrl(context), SETTINGS.page.mode, 'text');
      } else {
        var is_valid_regex = true;
        try {
          var temp_regex = new RegExp(regex);
        } catch (e) {
          is_valid_regex = false;
        }
      
        var textbox = $(context).closest('.page_record').find('.mode input[type=text]');
        var test_button = $(context).closest('.page_record').find('.mode input[type=button]');
        if (is_valid_regex) {
          textbox.removeClass('invalid');
          test_button.attr({ disabled: false });
          setPageSetting(findUrl(context), SETTINGS.page.regex, regex);
        } else {
          test_button.attr({ disabled: true });
          textbox.addClass('invalid');
        }
      }
    }
    
    function setPageSelector(context, selector) {
      if (selector === null)  {
        deletePageSetting(findUrl(context), SETTINGS.page.selector);
        setPageSetting(findUrl(context), SETTINGS.page.mode, 'text');
      } else {
        var is_valid_selector = true;
        try {
          $(selector);
        } catch (e) {
          is_valid_selector = false;
        }
      
        var textbox = $(context).closest('.page_record').find('.mode input[type=text]');
        var test_button = $(context).closest('.page_record').find('.mode input[type=button]');
        if (is_valid_selector) {
          textbox.removeClass('invalid');
          test_button.attr({ disabled: false });
          setPageSetting(findUrl(context), SETTINGS.page.selector, selector);
        } else {
          test_button.attr({ disabled: true });
          textbox.addClass('invalid');
        }
      }
    }
    
    function initializeSoundSelector() {
      var select = $('#sound_alert');
      var button = $('#sound_alert').siblings('input[type="button"]');
      
      select.change(function() {
        var audio_file = select.val();
        
        setSetting(SETTINGS.sound_alert, audio_file);
        
        button.attr({ disabled: audio_file == '' });
      });
      
      button.click(function() {
        select.attr({ disabled: true });
        button.attr({ disabled: true });
        
        var audio = new Audio(select.val());
        
        audio.addEventListener('ended', function() {
          select.attr({ disabled: false });
          button.attr({ disabled: false });
        });
        audio.play();
      });
      
      select.val(getSetting(SETTINGS.sound_alert) || '');
      select.change();
    }
    
    function exportPagesList() {
      var buffer = [];
      var page_urls = getSetting(SETTINGS.pages_list);
      var add_date = new Date().getTime();
      
      buffer.push('<!DOCTYPE NETSCAPE-Bookmark-file-1>\n\n<!-' +
                  '- This is an automatically generated file.\n     It will' +
                  ' be read and overwritten.\n     DO NOT EDIT! -' +
                  '->\n<META HTTP-EQUIV="Content-Type" CONTENT="text/html;' +
                  ' charset=UTF-8">\n<TITLE>Bookmarks</TITLE>\n<H1>' +
                  'Bookmarks</H1>\n<DL><p>\n');
      
      for (var i in page_urls) {
        var page_url = page_urls[i];
        var page_name = getPageSetting(page_url, SETTINGS.page.name);
        var page_icon = getPageSetting(page_url, SETTINGS.page.icon);
        var icon_attr = page_icon ? ' ICON_URI="' + page_icon + '" ' : '';
        buffer.push('        <DT><A HREF="' + page_url + '" ADD_DATE="' + add_date + '"' + icon_attr + '>' + page_name + '</A>\n');
      }
      
      buffer.push('</DL><p>');
      
      return buffer.join('');
    }
    
    function importPagesList(bookmarks) {
      var PAGE_REGEX = /<A[^<>]+>[^<>]+<\/A>/g;
      var page_links = bookmarks.match(PAGE_REGEX);
      
      for (var i in page_links) {
        var page_link = $(page_links[i]);
        var page_url = page_link.attr('HREF') || '';
        var page_name = page_link.text() || 'Untitled Page (' + page_url + ')';
        var page_icon = page_link.attr('ICON_URI') || null;
        
        if (page_url) addPage(page_url, page_name, page_icon);
      }
    }
    
    $(function() {
      // Set up the main color/timeout contols.
      initializeColorPicker();
      initializeTimeoutTextbox();
      initializeSoundSelector();
      
      // Set up the "Check All Now" button handler.
      $('#check_now').click(function() {
        var pages = getSetting(SETTINGS.pages_list);
          var pages_checked = 0;
        
        $('.last_check_time').text('checking..');
        
        $.each(pages, function(i, url) {
          checkPage(url, function() {
            if (++pages_checked == pages.length) {
              updateBadge();
            }
          });
        });
      });
      
      // Set up "rename page" live click handlers.
      $('.rename').live('click', function() {
        var record = $(this).closest('.page_record');
        var page_link = record.find('.page_link');
        
        if (!page_link.is(':hidden')) {
          var textbox = $('<input type="text" value="' + page_link.text() + '" />');
          var cancel_button = $('<input type="button" value="Cancel" />');
          var ok_button = $('<input type="button" value="Ok" />');
          
          cancel_button.click(function() {
            textbox.remove();
            ok_button.remove();
            cancel_button.remove();
            page_link.show();
          });
          
          ok_button.click(function() {
            page_link.text(textbox.val());
            setPageSetting(findUrl(this), SETTINGS.page.name, textbox.val());
            cancel_button.click();
          });
          
          page_link.hide();
          page_link.after(cancel_button).after(ok_button).after(textbox);
        }
      });
      
      // Set up "stop monitoring" live click handlers.
      $('.stop_monitoring').live('click', function() {
        var url = findUrl(this);
        
        removePage(url);
        updateBadge();
        
        $(this).closest('.page_record td').slideUp('slow', function() {
          if ($('#pages .page_record').length == 1) {
            $('#pages').animate(
              { height: '50px', opacity: 1 }, 'slow', fillPagesList
            );
          } else {
            fillPagesList();
          }
        });
      });
      
      // Set up advanced option expansion events.
      $('.advanced_toggle input[type=checkbox]').live('click', function() {
        if ($(this).is(':checked')) {
          $(this).closest('.page_record').find('.advanced_toggle').addClass('toggled');
          $(this).closest('.page_record').find('.advanced_controls').slideDown('fast');
          
          // Apply previously-set advanced settings.
          var timeout_div = $(this).closest('.page_record').find('.timeout');
          if (timeout_div.find(':checked').length > 0) {
            setPageTimeout(this, timeout_div.find('input[type=text]').val());
          }
          var regex_div = $(this).closest('.page_record').find('.regex');
          if (regex_div.find(':checked').length > 0) {
            setPageRegex(this, regex_div.find('input[type=text]').val());
          }
        } else {
          $(this).closest('.page_record').find('.advanced_controls').slideUp('fast', function() {
            $(this).closest('.page_record').find('.advanced_toggle').removeClass('toggled');
          });
          
          setPageTimeout(this, null);
          setPageRegex(this, null);
        }
      });
      
      // Set up advanced option enabling/disabling events.
      $('.advanced_controls input[type=checkbox]').live('click', function() {
        if ($(this).is(':checked')) {
          $(this).nextAll('span').addClass('enabled').removeClass('disabled');
          $(this).nextAll('span').find('input').attr({ disabled: false });
        } else {
          $(this).nextAll('span').addClass('disabled').removeClass('enabled');
          $(this).nextAll('span').find('input').attr({ disabled: true });
        }
      });
      
      $('.timeout input[type=checkbox]').live('click', function() {
        if ($(this).is(':checked')) {
          setPageTimeout(this, $(this).nextAll('span').find('input').val());
        } else {
          setPageTimeout(this, null);
        }
      });
      
      $('.mode input[type=checkbox]').live('click', function() {
        var url = findUrl(this);
        var record = $(this).closest('.page_record');
        
        if ($(this).is(':checked')) {
          $('.mode input[type=radio]:checked', record).click();
          $('.mode input[type=text]', record).keyup();
        } else {
          setPageSetting(url, SETTINGS.page.mode, 'text');
          deletePageSetting(url, SETTINGS.page.regex);
          deletePageSetting(url, SETTINGS.page.selector);
        }
      });
      
      // Set advanced option editing events.
      $('.timeout input[type=text]').live('keyup', function() {
        setPageTimeout(this, cleanTimeoutTextbox(this));
      });
      $('.mode input[type=text]').live('keyup', function() {
        var mode = $(this).closest('.page_record').find('input[type=radio]:checked').val();
        if (mode == 'regex') {
          setPageRegex(this, $(this).val());
        } else if (mode == 'selector') {
          setPageSelector(this, $(this).val());
        }
      });
      
      // Set up mode radio box click handler
      $('.mode input[type=radio]').live('click', function() {
        var url = findUrl(this);
        var record = $(this).closest('.page_record');
        var val = $(this).val();
        
        setPageSetting(url, SETTINGS.page.mode, val);
        $('.mode input[type=text]', record).keyup();
        
        var label = val.replace(/^./, function(c) {return c.toUpperCase();}) + ':';
        $('.mode_value span', record).text(label);
      });
      
      // Set up regex/selector test click handler
      $('.mode input[type=button]').live('click', function() {
        var url = findUrl(this);
        var mode = getPageSetting(url, SETTINGS.page.mode);
        var regex = getPageSetting(url, SETTINGS.page.regex);
        var selector = getPageSetting(url, SETTINGS.page.selector);
        var button = $(this);
        
        if ((mode == 'regex' && regex) || (mode == 'selector' && selector)) {
          $(this).val('Testing...');
          $(this).closest('.mode').find('input').attr({ disabled: true });
          $.ajax({
            url: url,
            success: function(html) {
              var results = '';
              if (mode == 'regex') {
                results = findAndFormatRegexMatches(html, regex);
              } else {
                results = findAndFormatSelectorMatches(html, selector);
              }
              if (results) {
                alert('Matched:\n' + results);
              } else {
                alert('No matches.');
              }
              setPageSetting(url, SETTINGS.page.crc,
                             cleanAndHashPage(html, mode, regex, selector));
            },
            error: function() {
              alert('Could not retrieve selected page.');
            },
            complete: function() {
              button.val('Test');
              button.closest('.mode').find('input').attr({ disabled: false });
            }
          });
        }
      });
      
      // Finally, fill the pages list.
      fillPagesList();
    });
  </script>
  <style type="text/css">
    body {
      width: 780px;
      margin: auto;
      padding-bottom: 5.5em;
      overflow-y: scroll;
    }
    
    hr {
      border-bottom: 1px #999 solid;
    }
    
    .main_controls {
      clear: both;
      padding-bottom: 15px;
    }
    
    .main_controls .util, .main_controls .util:link, .main_controls .util:visited {
      float: right;
      width: 250px;
      height: 1.6em;
    }
    
    .color_picker {
      display: inline-block;
      position: relative;
      top: 2px;
    }
    
    .toggled {
      position: relative;
      left: -1px;
      border: 1px solid #9eafd1;
      border-radius: 5px 5px 0px 0px;
      border-bottom: 1px white solid;
      margin-right: -2px;
      z-index: 1;
    }
    
    .advanced_controls {
      position: relative;
      top: -1px;
      left: -1px;
      border: 1px solid #9eafd1;
      margin-left: 50px;
      padding: 10px;
      padding-left: 20px;
      display: none;
      border-radius: 0px 5px 5px 5px;
    }
    
    .advanced_toggle input {
      position: relative;
      top: 2px;
    }
    
    .page_info {
      margin-bottom: 10px;
    }
    
    .advanced_controls div {
      margin-top: 5px;
    }
    
    .advanced_controls .disabled {
      color: #999999;
      -webkit-transition: color 0.2s linear;
    }
    
    .advanced_controls .enabled {
      color: #849ccb;
      -webkit-transition: color 0.2s linear;
    }
    
    .advanced_controls input[type=button] {
      height: 1.6em;
      position: relative;
      top: 1px;
    }
    
    .advanced_controls input[type=checkbox],
    .advanced_controls input[type=radio] {
      position: relative;
      top: 2px;
    }
    
    .mode input[type=text] {
      width: 400px;
      padding-left: 1px;
      height: 1em;
      border: 1px #bbb solid;
      -webkit-transition: background-color 0.2s linear;
    }
    
    .invalid {
      background: #fcc;
    }
    
    .timeout input[type=text] {
      width: 3em;
      text-align: center;
    }
    
    .page_info input {
      position: relative;
      top: -2px;
    }
    
    .page_info input[type=text] {
      width: 600px;
      height: 1.25em;
    }
    
    .main_controls input[type=text], .main_controls select {
      border: 1px #a4bceb solid;
    }
    
    .mode_selector {
      display:inline-block;
      vertical-align: top;
    }
    
    .mode_selector label {
      display:inline-block;
      margin-right: 80px;
    }
    
    .mode_value span {
      display:inline-block;
      width: 100px;
    }
    
    #badge_color_picker_container {
      position: relative;
      top: 3px;
    }
    
    #global_timeout {
      width: 3em;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>Monitored Pages</h1>
  <table id="templates">
    <tr class="page_record">
      <td>
        <div class="page_info">
          <img class="favicon" src="img/page.png" />
          <a class="page_link" title="Visit Page" href="#" target="_blank">Page</a>
        </div>
        <div class="page_controls">
          <label class="util advanced_toggle">
            <!--img src="img/plus.png" /-->
            <input type="checkbox" />
            advanced
          </label>
          <span class="util rename">
            <img src="img/rename.png" />
            rename page
          </span>
          <span class="util stop_monitoring">
            <img src="img/stop_monitoring.png" />
            stop monitoring
          </span>
          <span class="util last_check inactive">
            <img src="img/monitor.png" />
            Last Check: <span class="last_check_time">unknown</span>.
          </span>
          <div class="advanced_controls">
            <div class="timeout">
              <input type="checkbox" />
              <span class="disabled">
                Check every
                <input type="text" disabled="disabled" />
                minutes.
              </span>
            </div>
            <div class="mode">
              <input type="checkbox" />
              <span class="mode_selector disabled">
                Custom Mode:
                <label>
                  <input type="radio" name="mode" value="regex" disabled="disabled" />
                  Regex
                </label>
                <label>
                  <input type="radio" name="mode" value="selector" disabled="disabled" />
                  Selector
                </label>
                <br />
                <span class="mode_value">
                  <span>Regex:</span>
                  <input type="text" disabled="disabled" />
                  <input type="button" disabled="disabled" value="Test" />
                </span>
              </span>
            </div>
          </div>
        </div>
      </td>
    </tr>
    <tr class="empty">
      <td>
        No pages are being monitored.
      </td>
    </tr>
  </table>
  
  <table id="pages" cellspacing="0">
    <!-- Pages go here. -->
  </table>
  <hr />
  <p class="main_controls">
    <span class="util inactive">
      <img src="img/clock.png" />
      Check every
      <input type="text" id="global_timeout" value="180" maxlength="5" />
      minutes.
    </span>
    <span class="util inactive">
      <img src="img/sound.png" />
      Sound Alert:
      <select id="sound_alert">
        <option value="">None</option>
        <option value="http://work.max99x.com/cuckoo.ogg">Cuckoo</option>
        <option value="http://work.max99x.com/bell.ogg">Chime</option>
      </select>
      <input type="button" value="Play" />
    </span>
    <span class="util inactive" id="badge_color_picker_container">
      <img src="img/color.png" />
      Badge color:
      <input id="badge_color_picker" name="badge_color_picker" type="text" value="#00B400" />
    </span>
  </p>
  <p class="main_controls">
    <span class="util" id="check_now">
      <img src="img/refresh.png" />
      Check All Now
    </span>
  </p>
</body>
</html>